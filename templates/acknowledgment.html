{% extends 'base.html' %}

{% block title %}إقرار الاستلام - {{ program_info.ArabicName }}{% endblock %}

{% block content %}
<div class="card">
    <a href="{{ url_for('verify', program_name=program_name) }}" class="back-link">→ رجوع</a>
    
    <h2>إقرار بالاستلام</h2>
    
    <div class="user-details">
        <p><strong>رقم الهوية:</strong> {{ user.NationalID }}</p>
        <p><strong>الاسم الكامل:</strong> {{ user.FullName }}</p>
    </div>
    
    <div class="acknowledgment-text">
        <p>أقر أنا، <strong>{{ user.FullName }}</strong>، بأنني قد استلمت المواد/الأغراض من <strong>{{ program_info.ArabicName }}</strong>.</p>
    </div>
    
    <form method="POST" id="acknowledgment-form">
        <div class="form-group">
            <label>الرجاء التوقيع أدناه:</label>
            <div class="signature-container">
                <canvas id="signature-pad"></canvas>
            </div>
            <button type="button" class="btn btn-secondary" id="clear-btn">مسح التوقيع</button>
        </div>
        
        <input type="hidden" name="signature" id="signature-data">
        
        <button type="submit" class="btn btn-primary btn-large">تأكيد الاستلام</button>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
    const canvas = document.getElementById('signature-pad');
    const ctx = canvas.getContext('2d');
    const clearBtn = document.getElementById('clear-btn');
    const form = document.getElementById('acknowledgment-form');
    const signatureInput = document.getElementById('signature-data');
    
    let isDrawing = false;
    let lastX = 0;
    let lastY = 0;
    
    // Set canvas size
    function resizeCanvas() {
        const container = canvas.parentElement;
        canvas.width = container.offsetWidth;
        canvas.height = 200;
        // Fill with white background
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.strokeStyle = '#000';
        ctx.lineWidth = 2;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
    }
    
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);
    
    function getPos(e) {
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        
        if (e.touches) {
            return {
                x: (e.touches[0].clientX - rect.left) * scaleX,
                y: (e.touches[0].clientY - rect.top) * scaleY
            };
        }
        return {
            x: (e.clientX - rect.left) * scaleX,
            y: (e.clientY - rect.top) * scaleY
        };
    }
    
    function startDrawing(e) {
        isDrawing = true;
        const pos = getPos(e);
        lastX = pos.x;
        lastY = pos.y;
    }
    
    function draw(e) {
        if (!isDrawing) return;
        e.preventDefault();
        
        const pos = getPos(e);
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();
        lastX = pos.x;
        lastY = pos.y;
    }
    
    function stopDrawing() {
        isDrawing = false;
    }
    
    // Mouse events
    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseout', stopDrawing);
    
    // Touch events
    canvas.addEventListener('touchstart', startDrawing);
    canvas.addEventListener('touchmove', draw);
    canvas.addEventListener('touchend', stopDrawing);
    
    // Clear signature
    clearBtn.addEventListener('click', () => {
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
    });
    
    // Save signature before submit
    form.addEventListener('submit', (e) => {
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        let hasSignature = false;
        
        // Check if there's any non-white pixel
        for (let i = 0; i < imageData.data.length; i += 4) {
            if (imageData.data[i] < 250 || imageData.data[i+1] < 250 || imageData.data[i+2] < 250) {
                hasSignature = true;
                break;
            }
        }
        
        if (!hasSignature) {
            e.preventDefault();
            alert('الرجاء إضافة توقيعك قبل التأكيد');
            return;
        }
        
        signatureInput.value = canvas.toDataURL('image/png');
    });
</script>
{% endblock %}
